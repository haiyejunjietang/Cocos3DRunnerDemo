{"version":3,"sources":["file:///D:/tangjianhua/cocos%20games/JareAdventure_/assets/scripts/ForeverManager.ts"],"names":["_decorator","Component","director","instantiate","Node","Prefab","Vec3","ccclass","property","ForeverManager","blockStartPos","lastBlockIndex","start","getScene","on","onGameFail","i","createBlock","schedule","spawnInterval","update","dt","recycleBlock","randomIndex","blockList","length","Math","floor","random","block","parent","node","setPosition","z","blockLength","playerZ","player","position","children","despawnDistance","destroy","unscheduleAllCallbacks","onDestroy","scene","off"],"mappings":";;;;;;;;;;;;;;;;AAASA,MAAAA,U,OAAAA,U;AAAYC,MAAAA,S,OAAAA,S;AAAWC,MAAAA,Q,OAAAA,Q;AAAUC,MAAAA,W,OAAAA,W;AAAaC,MAAAA,I,OAAAA,I;AAAMC,MAAAA,M,OAAAA,M;AAAQC,MAAAA,I,OAAAA,I;;;;;;;;;OAE/D;AAAEC,QAAAA,OAAF;AAAWC,QAAAA;AAAX,O,GAAwBR,U;;gCAGjBS,c,WADZF,OAAO,CAAC,gBAAD,C,UAEHC,QAAQ,CAACH,MAAD,C,UAERG,QAAQ,CAACJ,IAAD,C,2BAJb,MACaK,cADb,SACoCR,SADpC,CAC8C;AAAA;AAAA;;AAAA;;AAEhB;AAFgB;;AAIrB;AAJqB;;AAMf;AANe;;AAQb;AARa;;AAUX;AAVW,eAYlCS,aAZkC,GAYZ,IAAIJ,IAAJ,CAAS,CAAT,EAAY,CAAZ,EAAe,GAAf,CAZY;AAAA,eAalCK,cAbkC,GAaT,CAAC,CAbQ;AAAA;;AAaL;AAErCC,QAAAA,KAAK,GAAG;AACJ;AACAV,UAAAA,QAAQ,CAACW,QAAT,GAAoBC,EAApB,CAAuB,OAAvB,EAAgC,KAAKC,UAArC,EAAiD,IAAjD,EAFI,CAGJ;;AACA,eAAK,IAAIC,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG,CAApB,EAAuBA,CAAC,EAAxB,EAA4B;AACxB,iBAAKC,WAAL;AACH;;AAED,eAAKC,QAAL,CAAc,KAAKD,WAAnB,EAAgC,KAAKE,aAArC;AACH;;AAEDC,QAAAA,MAAM,CAACC,EAAD,EAAa;AACf,eAAKC,YAAL,GADe,CACM;AACxB,SA5ByC,CA8B1C;;;AACQL,QAAAA,WAAW,GAAG;AAClB;AACA,cAAIM,WAAW,GAAG,KAAKZ,cAAvB;;AACA,iBAAOY,WAAW,KAAK,KAAKZ,cAArB,IAAuC,KAAKa,SAAL,CAAeC,MAAf,GAAwB,CAAtE,EAAyE;AACrEF,YAAAA,WAAW,GAAGG,IAAI,CAACC,KAAL,CAAWD,IAAI,CAACE,MAAL,KAAgB,KAAKJ,SAAL,CAAeC,MAA1C,CAAd;AACH;;AACD,eAAKd,cAAL,GAAsBY,WAAtB,CANkB,CAQlB;;AACA,gBAAMM,KAAK,GAAG1B,WAAW,CAAC,KAAKqB,SAAL,CAAeD,WAAf,CAAD,CAAzB;AACAM,UAAAA,KAAK,CAACC,MAAN,GAAe,KAAKC,IAApB;AACAF,UAAAA,KAAK,CAACG,WAAN,CAAkB,KAAKtB,aAAvB,EAXkB,CAYlB;;AACA,eAAKA,aAAL,CAAmBuB,CAAnB,IAAwB,KAAKC,WAA7B;AACH,SA7CyC,CA+C1C;;;AACQZ,QAAAA,YAAY,GAAG;AACnB,gBAAMa,OAAO,GAAG,KAAKC,MAAL,CAAYC,QAAZ,CAAqBJ,CAArC,CADmB,CAEnB;;AACA,eAAK,IAAIjB,CAAC,GAAG,KAAKe,IAAL,CAAUO,QAAV,CAAmBb,MAAnB,GAA4B,CAAzC,EAA4CT,CAAC,IAAI,CAAjD,EAAoDA,CAAC,EAArD,EAAyD;AACrD,kBAAMa,KAAK,GAAG,KAAKE,IAAL,CAAUO,QAAV,CAAmBtB,CAAnB,CAAd,CADqD,CAErD;;AACA,gBAAIa,KAAK,CAACQ,QAAN,CAAeJ,CAAf,GAAmBE,OAAO,GAAG,KAAKI,eAAtC,EAAuD;AACnDV,cAAAA,KAAK,CAACW,OAAN;AACH;AACJ;AACJ;;AAEOzB,QAAAA,UAAU,GAAG;AACjB,eAAK0B,sBAAL;AACH;;AACDC,QAAAA,SAAS,GAAG;AACZ,gBAAMC,KAAK,GAAGzC,QAAQ,CAACW,QAAT,EAAd;;AACA,cAAI8B,KAAJ,EAAW;AAAE;AACTA,YAAAA,KAAK,CAACC,GAAN,CAAU,OAAV,EAAmB,KAAK7B,UAAxB,EAAoC,IAApC;AACH;AACJ;;AApE6C,O;;;;;iBAEpB,E;;;;;;;iBAEP,I;;sFACdP,Q;;;;;iBACqB,G;;wFACrBA,Q;;;;;iBACuB,G;;0FACvBA,Q;;;;;iBACyB,G","sourcesContent":["import { _decorator, Component, director, instantiate, Node, Prefab, Vec3 } from 'cc';\r\nimport { Player } from './Player';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('ForeverManager')\r\nexport class ForeverManager extends Component {\r\n    @property(Prefab)\r\n    blockList: Prefab[] = []; // 存储3个方块预制体\r\n    @property(Node)\r\n    player: Node = null; // 绑定玩家节点（用于判断视野）\r\n    @property\r\n    blockLength: number = 100; // 方块长度（需和预制体实际尺寸一致）\r\n    @property\r\n    spawnInterval: number = 1.5; // 生成间隔（根据玩家速度调整）\r\n    @property\r\n    despawnDistance: number = 200; // 超出该距离的方块回收\r\n\r\n    private blockStartPos: Vec3 = new Vec3(0, 0, 255);\r\n    private lastBlockIndex: number = -1; // 记录上一个方块索引，避免连续重复\r\n\r\n    start() {\r\n        // 一次性绑定失败事件（移出update）\r\n        director.getScene().on('faild', this.onGameFail, this);\r\n        // 初始化生成3个方块作为初始关卡\r\n        for (let i = 0; i < 3; i++) {\r\n            this.createBlock();\r\n        }\r\n  \r\n        this.schedule(this.createBlock, this.spawnInterval);\r\n    }\r\n\r\n    update(dt: number) {\r\n        this.recycleBlock(); // 每帧检测并回收超出视野的方块\r\n    }\r\n\r\n    // 生成方块（优化随机逻辑）\r\n    private createBlock() {\r\n        // 随机选择预制体，避免连续重复\r\n        let randomIndex = this.lastBlockIndex;\r\n        while (randomIndex === this.lastBlockIndex && this.blockList.length > 1) {\r\n            randomIndex = Math.floor(Math.random() * this.blockList.length);\r\n        }\r\n        this.lastBlockIndex = randomIndex;\r\n\r\n        // 实例化方块\r\n        const block = instantiate(this.blockList[randomIndex]);\r\n        block.parent = this.node;\r\n        block.setPosition(this.blockStartPos);\r\n        // 更新下一个方块生成位置\r\n        this.blockStartPos.z += this.blockLength;\r\n    }\r\n\r\n    // 回收超出视野的方块\r\n    private recycleBlock() {\r\n        const playerZ = this.player.position.z;\r\n        // 遍历所有子节点（方块）\r\n        for (let i = this.node.children.length - 1; i >= 0; i--) {\r\n            const block = this.node.children[i];\r\n            // 当方块超出玩家后方指定距离时，销毁或回收（这里用销毁，简单高效）\r\n            if (block.position.z < playerZ - this.despawnDistance) {\r\n                block.destroy();\r\n            }\r\n        }\r\n    }\r\n\r\n    private onGameFail() {\r\n        this.unscheduleAllCallbacks();\r\n    }\r\n    onDestroy() {\r\n    const scene = director.getScene();\r\n    if (scene) { // 先判断场景是否存在\r\n        scene.off('faild', this.onGameFail, this);\r\n    }\r\n}\r\n}\r\n"]}